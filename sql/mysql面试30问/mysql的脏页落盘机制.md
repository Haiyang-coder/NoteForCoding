# mysql的脏页落盘机制

## mysql的落盘是通过checkpoint机制刷回磁盘的

redo log可能会出现的问题：

1. 缓冲池不是无限大的，所以必须刷新磁盘
2. redo log 也不是无限大的，写满了也需要刷新磁盘
3. 数据库运行时间长了，宕机之后，用redolog，这个过程是很耗时的，恢复成本比较高

用checkpoint机制解决上面的3个问题

1. 当缓冲池不够用的时候，刷盘
2. redo满的时候，刷盘
3. 缩短数据库恢复的时间

**当缓冲池不够用的时候**

- innoDB就会进行页的淘汰，LRU淘汰算法，将淘汰LRU尾部的页，如果淘汰的页是脏页的话就需要强制执行checkpoint，刷新到磁盘

**缩短数据库恢复的时间**

- 宕机的时候，不需要重做所有的日志，因为checkpoint机制，checkpoint之前的已经在磁盘了，只需要checkpoint后的日志来恢复就可以

**redo满的时候**

- 日志组：
  - mysql为了优化磁盘持久化的开销，会有一个组提交的机制
  - 每个innodb都会有一个重做日志文件组，每个组至少有两个redolog，循环使用redolog
  - redolog不可用，是所有的redolog都写满了（write pos 和 checkpoint pos之间的部分就是可以使用的部分）

**落盘机制**

1. 强制落盘：把内存中的所有的脏页都执行落盘操作。数据库关闭时执行
2. 模糊落盘
   1. 主线程定时将脏页写入磁盘，每秒或者每十秒执行一次
   2. pool有脏页换出，执行落盘
   3. redolog快写满的时候执行落盘
      1. redo 75-90异步落盘
      2. 90以上，阻塞写操作，同步落盘
   4. bufferpoll脏页太多，执行落盘