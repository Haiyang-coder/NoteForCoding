```mysql
start transaction;
update biliblili set status='关注' where ip = 20;
commit;
```

先写一个基础目录，大概有一个路线：

- 开启事务
- sql解析，查询计划的生成
- 查询要修改的数据
- 校验锁和加锁
- 修改数据和生成日志
- 本地提交
- 主备复制
- 返回提交成功
- 脏页刷入磁盘



## 1. 开启事务

 无论你是否主动开启了事务，innodb都会给你开启一个事务，在最后完成时自动或者主动提交

无论那种方式开启事务，**muydql都会在事务第一次执行增删改查的操作时，给事务分配一个事务号**，假定我们的事务号是1024

## 2. Sql解析，查询计划生成

<img src="./page/image-20240528161052701.png" alt="image-20240528161052701" style="zoom:67%;" />

1. 解析查询（SQL Parsing）：当 MySQL 接收到查询语句时，首先会对查询进行解析，生成解析树。
2. 优化查询：优化器会决定如何执行查询，选择最佳的索引和访问路径。
3. 使用索引定位数据页：假设 `id` 是主键或有索引，InnoDB 会利用 B+ 树索引来定位具体的数据页。

往后就不是服务层该关心的问题了

## 3. 查询要修改的数据

这时候就要设计==buffer pool + 磁盘==了

我们查询需要 ==表空间号+页号== 才能定位到我们想要查询的数据

1. **确定目标页**：
   
   - 解析 SQL 语句，找到表 `biliblili` 的表空间 ID。
   - 根据索引（假设 `ip` 字段是主键），确定包含 `ip= 20` 的数据页的页号。
   
   **你如何获取表空间号和页号？**
   
   1. 解析查询（SQL Parsing）：当 MySQL 接收到查询语句时，首先会对查询进行解析，生成解析树。
   2. 优化查询：优化器会决定如何执行查询，选择最佳的索引和访问路径。
   3. 使用索引定位数据页：假设 `id` 是主键或有索引，InnoDB 会利用 B+ 树索引来定位具体的数据页。
   4. 每个表在创建时，都会在数据字典中记录其表空间 ID。这是 InnoDB 系统表的一部分。可以通过查询 `INFORMATION_SCHEMA.INNODB_SYS_TABLES` 来查看表的表空间 ID
   
   
   
2. **在 Buffer Pool 中查找**：
   - 组合表空间 ID 和页号，作为哈希表（注意了，这里有hash表）的键。
   - 在哈希表中查找是否有这个键对应的数据页。
   
3. **返回结果**：
   
   - 如果找到，则直接从 Buffer Pool 读取数据并返回。
   - 如果没有找到，则从磁盘读取相应的数据页到 Buffer Pool，然后返回数据。

## 4. 校验锁和加锁